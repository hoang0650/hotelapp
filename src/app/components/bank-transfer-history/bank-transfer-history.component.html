<div class="bank-transfer-history-container">
  <nz-card nzTitle="Lịch sử giao dịch ngân hàng" nzBordered="true" [nzBodyStyle]="{padding: '24px'}">
    <form [formGroup]="searchForm" (ngSubmit)="onFilterSubmit()" class="filter-form" style="margin-bottom: 16px; display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end;">
      <nz-range-picker formControlName="dateRange" style="width: 240px;" nzFormat="dd/MM/yyyy"></nz-range-picker>
      <nz-select formControlName="status" nzAllowClear nzPlaceHolder="Trạng thái" style="width: 140px;">
        <nz-option nzValue="success" nzLabel="Thành công"></nz-option>
        <nz-option nzValue="pending" nzLabel="Đang xử lý"></nz-option>
        <nz-option nzValue="failed" nzLabel="Thất bại"></nz-option>
      </nz-select>
      <nz-select formControlName="bankName" nzAllowClear nzPlaceHolder="Ngân hàng" style="width: 160px;">
        <nz-option *ngFor="let col of bankNameFilters" [nzValue]="col.value" [nzLabel]="col.text"></nz-option>
      </nz-select>
      <input nz-input formControlName="searchKeyword" placeholder="Tìm kiếm nội dung/mã tham chiếu/số TK" style="width: 220px;" />
      <button nz-button nzType="primary" [disabled]="isLoading" htmlType="submit">Lọc</button>
      <button nz-button nzType="default" (click)="onResetFilter()" [disabled]="isLoading" type="button">Xóa lọc</button>
    </form>

    <div style="margin-bottom: 8px;">
      <a href="https://my.sepay.vn/register?gcid=356" target="_blank" rel="noopener" style="color: #1890ff; font-weight: 500; text-decoration: underline;">Lấy token SePay tại đây</a>
    </div>

    <div class="token-input-row" style="margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
      <input nz-input [(ngModel)]="sepayToken" name="sepayToken" placeholder="Nhập API Token SePay..." style="width: 350px;" (ngModelChange)="onTokenChange($event)" />
      <button nz-button nzType="default" (click)="logoutSepay()" *ngIf="sepayToken">Đăng xuất</button>
      <span *ngIf="sepayToken" style="color: green; font-size: 13px;">Đã xác thực với SePay</span>
      <span *ngIf="!sepayToken" style="color: #888; font-size: 13px;">(Token này lấy từ dashboard SePay)</span>
    </div>

    <nz-alert *ngIf="errorMessage" nzType="error" [nzMessage]="errorMessage" nzShowIcon class="error-alert"></nz-alert>

    <div *ngIf="isLoading" class="loading-spinner">
      <nz-spin nzSimple [nzSize]="'large'"></nz-spin>
      <p>Đang tải dữ liệu...</p>
    </div>

    <div *ngIf="!isLoading && !errorMessage">
      <nz-table
        #sepayTable
        [nzData]="transactions"
        [nzLoading]="isLoading"
        [nzPageSize]="pageSize"
        [nzPageIndex]="pageIndex"
        [nzTotal]="totalTransactions"
        (nzPageIndexChange)="onPageIndexChange($event)"
        (nzPageSizeChange)="onPageSizeChange($event)"
        nzShowSizeChanger
        nzShowQuickJumper
        [nzFrontPagination]="false"
        nzBordered
        nzSize="middle"
        [nzScroll]="{ x: '1200px' }"
      >
        <thead>
          <tr>
            <th *ngFor="let column of listOfColumns"
                [nzSortOrder]="column.sortOrder"
                [nzSortFn]="column.sortFn"
                [nzSortDirections]="column.sortDirections"
                [nzFilterMultiple]="column.filterMultiple"
                [nzFilters]="column.listOfFilter || []"
                [nzFilterFn]="column.filterFn || true">
              {{ column.name }}
            </th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let data of sepayTable.data" [ngClass]="getRowClass(data)">
            <td>{{ data.id }}</td>
            <td>{{ data.bank_brand_name }}</td>
            <td>{{ data.account_number }}</td>
            <td>{{ data.transaction_date | date:'dd/MM/yyyy HH:mm:ss' }}</td>
            <td class="amount-out" style="text-align:right; color:#cf1322;">
              {{ data.amount_out | number:'1.0-0' }} VND
            </td>
            <td class="amount-in" style="text-align:right; color:#389e0d;">
              {{ data.amount_in | number:'1.0-0' }} VND
            </td>
            <td>
              <span nz-tooltip [nzTooltipTitle]="data.transaction_content || ''">
                {{ (data.transaction_content || '') | slice:0:30 }}<ng-container *ngIf="(data.transaction_content || '').length > 30">...</ng-container>
              </span>
            </td>
            <td>{{ data.reference_number }}</td>
          </tr>
        </tbody>
      </nz-table>
      <div *ngIf="!isLoading && transactions.length === 0 && !errorMessage" class="no-data-message">
        <nz-empty nzNotFoundContent="Không có dữ liệu giao dịch cho khoảng thời gian đã chọn."></nz-empty>
      </div>
    </div>
  </nz-card>
</div> 